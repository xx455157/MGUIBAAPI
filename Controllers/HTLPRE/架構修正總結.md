# HTLPRE Controllers 架構修正總結

## 修正日期
2025-01-16

## 問題描述

之前創建的 Controllers 不符合 MGUIBAAPI 的標準架構模式，主要問題：

### ❌ 錯誤的結構
1. 繼承自 `ControllerBase` 而不是 `GUIAppAuthController`
2. 使用了 `[ApiController]` 屬性
3. 使用 `async Task<IActionResult>` 返回類型
4. 沒有使用 BLL 層，直接在 Controller 中處理業務邏輯
5. 沒有使用 `#region` 組織代碼
6. 沒有私用屬性來存儲 BLL 實例
7. 引用了不正確的 Models（HTLPRE目錄下的自定義Models）

## 修正後的架構

### ✅ 正確的結構（參考 General/Pattern/BkDateController.cs）

#### 1. 繼承基類
```csharp
public class BkDateController : GUIAppAuthController
```
- `GUIAppAuthController` - 需要身份驗證
- `GUIAppAnonAuthController` - 不需要身份驗證

#### 2. 使用 #region 組織代碼
```csharp
#region " 匯入的名稱空間：Framework "
// Framework 引用
#endregion

#region " 匯入的名稱空間：GoldenUp "
// GoldenUp 系統引用
#endregion

#region " 私用屬性 "
// BLL 屬性
#endregion

#region " 共用函式 - 查詢資料 "
// 查詢方法
#endregion
```

#### 3. BLL 層調用
```csharp
private BlBkDate BlBkDate => new BlBkDate(ClientContent);
```

#### 4. 直接返回 Model 類型
```csharp
[HttpGet("{typeId}")]
public MdBKDate GetHelp(string typeId)
{
    return BlBkDate.GetHelp(typeId);
}
```

## 修正的文件清單

### Controllers（已修正）
| 文件 | 使用的 BLL | 使用的 Model | 說明 |
|------|-----------|-------------|------|
| `BkDateController.cs` | BlBkDate (Share) | MdBKDate | 會計日期查詢 |
| `RoomsController.cs` | BlRooms (Private) | MdRoomPayment | 房間資料查詢 |
| `ConfigController.cs` | BlCodes (Share) | MdCode | 配置資料查詢（房型、樓層、班別） |
| `BillsController.cs` | BlCodes (Share) | MdCode | 帳務資料查詢（帳夾） |
| `ReportsController.cs` | BlRoomsAnalysis (Private) | TBD | 報表資料查詢 |

### Models（正確位置）
位於 `D:\GUIMobile\Packages\SRC\GUIStd.DAL.AllNewHTL\Models\HTLPRE\`
- `MdBusinessDate.cs`
- `MdRoomInfo.cs`
- `MdBillInfo.cs`
- `MdConfig.cs`
- `MdReport.cs`

**注意**：這些 Models 是為 HTLPRE 模組專用的，已使用正確的命名規範（Md 前綴）和繁體中文註解。

## 架構原則

### ✅ 必須遵守
1. Controller 必須繼承 `GUIAppAuthController` 或 `GUIAppAnonAuthController`
2. 必須通過 BLL 層調用業務邏輯
3. 使用 `#region` 組織代碼結構
4. 所有註解使用繁體中文
5. BLL 屬性使用 lambda 表達式懶加載
6. 傳遞 `ClientContent` 給 BLL 構造函數
7. 使用基類的 `CurrentLang` 屬性處理多語言

### ❌ 禁止事項
1. 不要繼承 `ControllerBase`
2. 不要使用 `[ApiController]` 屬性
3. 不要使用 `async Task<IActionResult>`（除非特殊需求）
4. 不要在 Controller 中直接操作資料庫
5. 不要跳過 BLL 層
6. 不要使用簡體中文註解
7. 不要創建不符合命名規範的 Models

## 三層架構流程

```
前端請求
    ↓
Controller (HTLPRE/BkDateController)
    ↓ 調用 BLL
Business Logic Layer (BlBkDate)
    ↓ 調用 DAL
Data Access Layer (DaHTKY)
    ↓ 執行 SQL
MSSQL Database (HTKY 表)
```

## 參考文件

- **標準 Controller**: `D:\GUIMobile\WebCoreAPI\MGUIBAAPI\MGUIBAAPI\Controllers\General\Pattern\BkDateController.cs`
- **標準 BLL**: `D:\GUIMobile\Packages\SRC\GUIStd.BLL.AllNewHTL\Share\BlBkDate.cs`
- **標準 Model**: `D:\GUIMobile\Packages\SRC\GUIStd.DAL.AllNewHTL\Models\Share\MdBKDate.cs`
- **命名參考**: `D:\GUIMobile\Packages\SRC\GUIStd.DAL.AllNewHTL\Models\Private\Configs\MdWaitingConfig.cs`

## 記憶體儲存

所有架構模式已記錄到 graphiti-memory 中，組別：`HTLPRE_Architecture`

包含以下記憶：
1. MGUIBAAPI Controller 標準架構模式
2. MGUIBAAPI BLL 標準架構模式
3. MGUIBAAPI Model 標準架構模式
4. MGUIBAAPI 三層架構完整說明
5. HTLPRE 模組資料表對應關係
6. HTLPRE Controller 創建完整流程

使用 `mcp_graphiti-memory_search_memory_nodes` 工具可以隨時檢索這些知識。

## 後續工作

1. ✅ Controllers 已按照正確架構重新創建
2. ✅ Models 已放置在正確的 DAL 層位置
3. ✅ 所有註解已改為繁體中文
4. ✅ 架構知識已記錄到 graphiti-memory
5. ⏳ 需要根據實際業務需求完善 ReportsController 的具體方法
6. ⏳ 需要在 Visual Studio 中編譯測試
7. ⏳ 需要使用 Postman/Swagger 測試 API 端點
8. ⏳ 可能需要創建對應的 BLL 方法（如果現有的不足）

## 重要提醒

在創建新的 Controller 時，務必：
1. 先從 graphiti-memory 檢索架構知識
2. 參考 General/Pattern/BkDateController.cs
3. 確認所需的 BLL 和 Model 是否已存在
4. 遵循命名規範和代碼組織結構
5. 使用繁體中文註解
